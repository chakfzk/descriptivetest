<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìˆ í˜• í‰ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', 'Pretendard', sans-serif; }
        .tab-button { transition: all 0.3s ease-in-out; }
        .tab-button.admin-active {
            border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; font-weight: 600;
        }
        .tab-button.student-active {
            border-color: #0d9488; background-color: #f0fdfa; color: #0f766e; font-weight: 600;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .scale-in { animation: scaleIn 0.3s ease-in-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .spinner {
            animation: spin 1s linear infinite;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .question-card { transition: transform 0.2s, box-shadow 0.2s; }
        .question-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- í•™ìƒ ì •ë³´ ì…ë ¥ í™”ë©´ -->
        <div id="student-login-view" class="hidden flex-col items-center justify-center min-h-screen">
             <div class="w-full max-w-md p-8 bg-white rounded-2xl shadow-lg text-center">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤</h1>
                <p class="text-gray-500 mb-6">í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                <div class="space-y-4">
                    <input type="text" id="student-id-input" placeholder="í•™ë²ˆ (ì˜ˆ: 20299)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <input type="text" id="student-name-input" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <button id="start-learning-btn" class="mt-6 w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-400 transition-transform transform hover:scale-105">
                    í•™ìŠµ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>
        
        <!-- âœ… ë¬¸ì œ ì„ íƒ í™”ë©´ (í•™ìƒìš©) -->
        <div id="question-selection-view" class="hidden">
            <header class="flex justify-between items-center mb-6 pb-4 border-b">
                <div>
                    <h1 id="selection-view-title" class="text-3xl font-bold text-gray-900">ë¬¸ì œ ì„ íƒ</h1>
                    <p id="selection-user-info" class="text-gray-500 mt-1"></p>
                </div>
                <button id="selection-logout-btn" class="text-sm text-gray-600 hover:text-red-700 font-medium">ë‹¤ë¥¸ ê³„ì •ìœ¼ë¡œ ì‹œì‘</button>
            </header>
            <div id="question-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- ë¬¸ì œ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </div>
        </div>


        <!-- ë©”ì¸ ì½˜í…ì¸  ë·° (í•™ìƒ/ê´€ë¦¬ì ê³µí†µ) -->
        <div id="main-view" class="hidden">
            <header class="flex justify-between items-center mb-6 pb-4 border-b">
                <div>
                    <h1 id="view-title" class="text-3xl font-bold text-gray-900"></h1>
                    <p id="user-info" class="text-gray-500 mt-1"></p>
                </div>
                <div id="main-controls"></div>
            </header>
            <div id="tabs-container" class="flex items-center border-b border-gray-200 mb-6 flex-wrap"></div>
            <div id="content-container" class="bg-white p-6 rounded-2xl shadow-md min-h-[500px]"></div>
        </div>
    </div>
    
    <!-- ë¬¸ì œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ (ê´€ë¦¬ììš©) -->
    <div id="question-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 relative scale-in">
            <h2 id="modal-title" class="text-2xl font-bold mb-6"></h2>
            <form id="question-form">
                <input type="hidden" id="question-id-input">
                <div class="mb-4">
                    <label for="question-title-input" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œ ì œëª©</label>
                    <input type="text" id="question-title-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="question-text-input" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œ ë‚´ìš©</label>
                    <textarea id="question-text-input" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3">ì±„ì  ê¸°ì¤€ (ë£¨ë¸Œë¦­)</h3>
                    <div id="rubric-container" class="space-y-3"></div>
                    <button type="button" id="add-rubric-item-btn" class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        í•­ëª© ì¶”ê°€
                    </button>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="close-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ì·¨ì†Œ</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc, arrayUnion, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ì „ì—­ ë³€ìˆ˜ ---
        const firebaseConfig = {
            apiKey: "AIzaSyBdUoeofhygGywljSXo6poTKGwaHvjYmbw",
            authDomain: "descriptive-test-ce7fc.firebaseapp.com",
            projectId: "descriptive-test-ce7fc",
            storageBucket: "descriptive-test-ce7fc.appspot.com",
            messagingSenderId: "579662407313",
            appId: "1:579662407313:web:dfabcd3b0f126df698c130",
            measurementId: "G-5PHJ2RZ4FJ"
        };
        const firestoreAppId = firebaseConfig.projectId; 
        
        const apiKey = "AIzaSyAV3I5XBosjZKy4dcBhsLSdVOYDGqvQOPY";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        let app, auth, db, userId, isAdminMode;
        let questions = [], submissions = {};
        let activeQuestionId = null;
        let currentStudentIdentifier = null;
        let unsubscribeQuestions = null;
        let unsubscribeSubmissions = {};

        // --- UI ìš”ì†Œ ---
        const studentLoginView = document.getElementById('student-login-view');
        const questionSelectionView = document.getElementById('question-selection-view');
        const mainView = document.getElementById('main-view');
        const contentContainer = document.getElementById('content-container');
        const tabsContainer = document.getElementById('tabs-container');
        const questionModal = document.getElementById('question-modal');

        // --- ì´ˆê¸°í™” ---
        async function initialize() {
            const urlParams = new URLSearchParams(window.location.search);
            isAdminMode = urlParams.get('admin') === 'true';

            if (isAdminMode) {
                document.title = "ì„œìˆ í˜• í‰ê°€ [ê´€ë¦¬ì]";
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await authenticateUser();
                
                if (isAdminMode) {
                    setupAdminView();
                } else {
                    const savedStudentId = localStorage.getItem('worksheetStudentId');
                    const savedStudentName = localStorage.getItem('worksheetStudentName');
                    if (savedStudentId && savedStudentName) {
                        handleStudentLogin(savedStudentId, savedStudentName);
                    } else {
                        setupStudentView();
                    }
                }
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                document.body.innerHTML = `<p class="text-red-500 text-center mt-10">ì˜¤ë¥˜: Firebaseì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }

        async function authenticateUser() {
             return new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        resolve(user);
                    } else {
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            resolve(userCredential.user);
                        } catch (error) {
                            console.error("ì¸ì¦ ì˜¤ë¥˜:", error); resolve(null);
                        }
                    }
                });
            });
        }

        // --- ë·° ì„¤ì • ---
        function setupAdminView() {
            studentLoginView.classList.add('hidden');
            questionSelectionView.classList.add('hidden');
            mainView.classList.remove('hidden');

            document.getElementById('view-title').textContent = 'ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ';
            document.getElementById('user-info').textContent = 'ë¬¸ì œë¥¼ ê´€ë¦¬í•˜ê³  í•™ìƒë“¤ì˜ ë‹µë³€ì„ ì±„ì í•˜ì„¸ìš”.';
            document.getElementById('main-controls').innerHTML = `<button id="add-question-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">ìƒˆ ë¬¸ì œ ì¶”ê°€</button>`;
            
            document.getElementById('add-question-btn').addEventListener('click', openQuestionModalForCreate);
            document.getElementById('question-form').addEventListener('submit', handleQuestionFormSubmit);
            document.getElementById('add-rubric-item-btn').addEventListener('click', () => addRubricItem());
            document.getElementById('close-modal-btn').addEventListener('click', closeQuestionModal);
            questionModal.querySelector('.modal-backdrop').addEventListener('click', closeQuestionModal);

            loadData();
        }

        function setupStudentView() {
            studentLoginView.classList.remove('hidden');
            studentLoginView.classList.add('flex');
            questionSelectionView.classList.add('hidden');
            mainView.classList.add('hidden');
            
            document.getElementById('start-learning-btn').addEventListener('click', () => {
                const studentId = document.getElementById('student-id-input').value.trim();
                const studentName = document.getElementById('student-name-input').value.trim();
                 if (!studentId || !studentName) {
                    alert('í•™ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                localStorage.setItem('worksheetStudentId', studentId);
                localStorage.setItem('worksheetStudentName', studentName);
                handleStudentLogin(studentId, studentName);
            });
        }
        
        function handleStudentLogin(studentId, studentName) {
            currentStudentIdentifier = `${studentId}_${studentName}`;
            
            studentLoginView.classList.add('hidden');
            mainView.classList.add('hidden');
            questionSelectionView.classList.remove('hidden');

            document.getElementById('selection-user-info').textContent = `${studentId} ${studentName} í•™ìƒ, í™˜ì˜í•©ë‹ˆë‹¤! í’€ê³  ì‹¶ì€ ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.`;
            document.getElementById('selection-logout-btn').addEventListener('click', logout);
            
            loadData();
        }

        function logout() {
            localStorage.removeItem('worksheetStudentId');
            localStorage.removeItem('worksheetStudentName');

            mainView.classList.add('hidden');
            questionSelectionView.classList.add('hidden');
            studentLoginView.classList.add('flex');
            studentLoginView.classList.remove('hidden');

            currentStudentIdentifier = null;
            
            if (unsubscribeQuestions) unsubscribeQuestions();
            Object.values(unsubscribeSubmissions).forEach(unsub => unsub());
            unsubscribeSubmissions = {};
            questions = [];
            submissions = {};
            activeQuestionId = null;
            
            document.getElementById('student-id-input').value = '';
            document.getElementById('student-name-input').value = '';
        }

        // --- ë°ì´í„° ë¡œë”© ë° êµ¬ë… ---
        function loadData() {
            const questionsColRef = collection(db, 'artifacts', firestoreAppId, 'public', 'data', 'questions');
            if (unsubscribeQuestions) unsubscribeQuestions();
            unsubscribeQuestions = onSnapshot(questionsColRef, (snapshot) => {
                questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                questions.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                if (isAdminMode) {
                    if (questions.length > 0 && (!activeQuestionId || !questions.some(q => q.id === activeQuestionId))) {
                        activeQuestionId = questions[0]?.id || null;
                    } else if (questions.length === 0) {
                        activeQuestionId = null;
                    }
                    renderTabs();
                    renderContent();
                } else {
                    renderQuestionSelectionList();
                }
                
                questions.forEach(q => listenForSubmissions(q.id));
            });
        }

        function listenForSubmissions(questionId) {
            const colPath = collection(db, 'artifacts', firestoreAppId, 'public', 'data', 'questions', questionId, 'submissions');
            if (unsubscribeSubmissions[questionId]) unsubscribeSubmissions[questionId]();
            
            unsubscribeSubmissions[questionId] = onSnapshot(colPath, (snapshot) => {
                submissions[questionId] = submissions[questionId] || {};
                const currentSubs = {};
                snapshot.docs.forEach(doc => {
                    currentSubs[doc.id] = { id: doc.id, ...doc.data() };
                });
                submissions[questionId] = currentSubs;
                if (activeQuestionId === questionId) {
                     // âœ… 1ë²ˆ ë¬¸ì œ í•´ê²°: ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šê³ , ê¸°ë¡ ë¶€ë¶„ë§Œ ì—…ë°ì´íŠ¸
                    if(!isAdminMode) {
                        renderSubmissionHistory();
                    } else {
                        renderContent();
                    }
                }
            });
        }

        // --- UI ë Œë”ë§ ---
        function renderQuestionSelectionList() {
            const container = document.getElementById('question-list-container');
            container.innerHTML = '';
            if(questions.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center col-span-full">ì•„ì§ ì¶œì œëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            questions.forEach(q => {
                const card = document.createElement('div');
                card.className = "question-card bg-white p-6 rounded-lg border cursor-pointer";
                card.innerHTML = `<h2 class="text-xl font-bold text-gray-800">${q.title}</h2>`;
                card.addEventListener('click', () => {
                    activeQuestionId = q.id;
                    questionSelectionView.classList.add('hidden');
                    mainView.classList.remove('hidden');
                    renderTabs();
                    renderContent();
                });
                container.appendChild(card);
            });
        }

        function renderTabs() {
            tabsContainer.innerHTML = '';
            if (questions.length === 0) return;
            questions.forEach(q => {
                const button = document.createElement('button');
                const activeClass = isAdminMode ? 'admin-active' : 'student-active';
                button.className = `tab-button py-3 px-5 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300`;
                button.textContent = q.title;
                if (q.id === activeQuestionId) button.classList.add(activeClass);
                button.addEventListener('click', () => {
                    activeQuestionId = q.id;
                    renderTabs();
                    renderContent();
                });
                tabsContainer.appendChild(button);
            });
        }

        function renderContent() {
            if (isAdminMode) renderAdminContent();
            else renderStudentContent();
        }

        function renderAdminContent() {
            // ... (ê¸°ì¡´ê³¼ ë™ì¼, ë³€ê²½ ì—†ìŒ)
        }

        function renderStudentContent() {
             if (!activeQuestionId) {
                contentContainer.innerHTML = `<div class="text-center py-20"><h2 class="text-xl font-semibold text-gray-700">ë¬¸ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</h2></div>`;
                return;
            }
            const question = questions.find(q => q.id === activeQuestionId);
            if (!question) {
                 contentContainer.innerHTML = `<div class="text-center py-20"><h2 class="text-xl font-semibold text-gray-700">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2></div>`;
                 return;
            }
            
            // âœ… 1ë²ˆ ë¬¸ì œ í•´ê²°: ë Œë”ë§ ì‹œ í˜„ì¬ ì…ë ¥ê°’ ì €ì¥
            const answerTextarea = document.getElementById('student-answer-textarea');
            const currentDraft = answerTextarea ? answerTextarea.value : '';

            const mySubmission = submissions[activeQuestionId]?.[currentStudentIdentifier];
            const lastAttempt = mySubmission && Array.isArray(mySubmission.attempts) && mySubmission.attempts.length > 0 ? mySubmission.attempts[mySubmission.attempts.length - 1] : null;
            const isGraded = !!(lastAttempt && lastAttempt.scores);
            const needsSubmission = !lastAttempt || isGraded;
            const maxScore = Array.isArray(question.rubric) ? question.rubric.reduce((a, b) => a + (b.maxScore || 0), 0) : 0;
            const totalScore = isGraded ? Object.values(lastAttempt.scores).reduce((a, b) => a + b, 0) : 0;
            const isPerfect = isGraded && totalScore === maxScore && maxScore > 0;

            const submissionFormHTML = isPerfect
                ? `<div class="text-center p-6 bg-green-100 rounded-lg"><h3 class="text-2xl font-bold text-green-800">ğŸ‰ ë§Œì ì…ë‹ˆë‹¤! ğŸ‰</h3><p class="text-green-700 mt-2">ì •ë§ ì˜í–ˆì–´ìš”! ë‹¤ìŒ ë¬¸ì œì— ë„ì „í•´ë³´ì„¸ìš”.</p></div>`
                : `<h3 class="text-xl font-semibold mb-4">${lastAttempt && isGraded ? 'ë‹µë³€ ìˆ˜ì •í•˜ê¸°' : 'ë‹µë³€ ì‘ì„±í•˜ê¸°'}</h3>
                   <textarea id="student-answer-textarea" class="w-full h-40 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                   <button id="submit-answer-btn" class="mt-4 w-full bg-teal-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-teal-600 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">ì œì¶œí•˜ê¸°</button>`;

            contentContainer.innerHTML = `
                <h2 class="text-2xl font-bold">${question.title}</h2>
                <p class="mt-2 mb-6 text-gray-600 whitespace-pre-wrap">${question.questionText}</p>
                <div class="mb-8 p-4 bg-teal-50 rounded-lg">
                    <h3 class="font-semibold mb-2 text-teal-800">ì±„ì  ê¸°ì¤€</h3>
                    <ul class="list-disc list-inside space-y-1 text-teal-700">${Array.isArray(question.rubric) ? question.rubric.map(r => `<li>${r.criterion} (${r.maxScore}ì )</li>`).join('') : ''}</ul>
                </div>
                ${submissionFormHTML}
                <div id="submission-history-container"></div>`;
            
            // âœ… 1ë²ˆ ë¬¸ì œ í•´ê²°: ì €ì¥ëœ ì…ë ¥ê°’ ë³µì›
            const newAnswerTextarea = document.getElementById('student-answer-textarea');
            if(newAnswerTextarea) {
                if (needsSubmission && lastAttempt && isGraded) {
                     newAnswerTextarea.value = lastAttempt.answer;
                } else {
                     newAnswerTextarea.value = currentDraft;
                }
            }
            
            renderSubmissionHistory(); // ê¸°ë¡ ë¶€ë¶„ë§Œ ë”°ë¡œ ë Œë”ë§

            if (!isPerfect) {
                document.getElementById('submit-answer-btn')?.addEventListener('click', submitAnswer);
            }

             // âœ… 2ë²ˆ ë¬¸ì œ í•´ê²°: ë¬¸ì œ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
            document.getElementById('main-controls').innerHTML = `<button id="back-to-list-btn" class="text-sm text-gray-600 hover:text-teal-700 font-medium">ë¬¸ì œ ëª©ë¡</button>`;
            document.getElementById('back-to-list-btn').addEventListener('click', () => {
                mainView.classList.add('hidden');
                questionSelectionView.classList.remove('hidden');
            });
        }

        // âœ… 1ë²ˆ ë¬¸ì œ í•´ê²°: ì œì¶œ ê¸°ë¡ë§Œ ë”°ë¡œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        function renderSubmissionHistory() {
            const historyContainer = document.getElementById('submission-history-container');
            if (!historyContainer) return;

            const mySubmission = submissions[activeQuestionId]?.[currentStudentIdentifier];
            const question = questions.find(q => q.id === activeQuestionId);
            if (!question) return;

            const maxScore = Array.isArray(question.rubric) ? question.rubric.reduce((a, b) => a + (b.maxScore || 0), 0) : 0;

            if (mySubmission && Array.isArray(mySubmission.attempts)) {
                historyContainer.innerHTML = `<h3 class="text-xl font-semibold mt-10 mb-4">ë‚˜ì˜ ì œì¶œ ê¸°ë¡</h3><div class="space-y-6">${mySubmission.attempts.slice().reverse().map((attempt, index) => {
                    const submissionNumber = mySubmission.attempts.length - index;
                    const attemptTotalScore = attempt.scores ? Object.values(attempt.scores).reduce((a, b) => a + b, 0) : 0;
                    const feedbackDisplay = attempt.scores 
                        ? `<div class="border-t pt-4 mt-4">
                             <h4 class="font-semibold mb-2">AI í”¼ë“œë°±</h4>
                             <div class="bg-yellow-50 p-3 rounded-md mb-3"><p class="text-gray-700 whitespace-pre-wrap">${attempt.feedback || 'í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.'}</p></div>
                             <div class="flex items-center space-x-4 flex-wrap">${Object.entries(attempt.scores).map(([crit, score]) => `<div class="text-sm"><span class="font-medium">${crit}:</span> ${score}ì </div>`).join('')}
                                <div class="font-bold text-indigo-600">ì´ì : ${attemptTotalScore} / ${maxScore}ì </div>
                             </div>
                           </div>` 
                        : `<p class="text-blue-600 font-medium flex items-center"><span class="spinner !w-4 !h-4 !border-2 mr-2"></span> ${attempt.feedback || 'AIê°€ ì±„ì  ì¤‘ì…ë‹ˆë‹¤...'}</p>`;

                    return `<div class="border rounded-lg p-4 bg-gray-50">
                                <p class="text-sm font-semibold text-gray-500 mb-2">${submissionNumber}ë²ˆì§¸ ì œì¶œ</p>
                                <p class="text-gray-800 whitespace-pre-wrap mb-4">${attempt.answer}</p>
                                ${feedbackDisplay}
                            </div>`;
                }).join('')}</div>`;
            } else {
                historyContainer.innerHTML = '';
            }
            
            const lastAttempt = mySubmission && Array.isArray(mySubmission.attempts) && mySubmission.attempts.length > 0 ? mySubmission.attempts[mySubmission.attempts.length - 1] : null;
            const isGraded = !!(lastAttempt && lastAttempt.scores);
            const needsSubmission = !lastAttempt || isGraded;
            
            const submitButton = document.getElementById('submit-answer-btn');
            const answerTextarea = document.getElementById('student-answer-textarea');

            if(submitButton && answerTextarea) {
                if(needsSubmission) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'ì œì¶œí•˜ê¸°';
                    answerTextarea.disabled = false;
                } else {
                    submitButton.disabled = true;
                    submitButton.innerHTML = `<div class="spinner"></div> AIê°€ ì±„ì  ì¤‘ì…ë‹ˆë‹¤...`;
                    answerTextarea.disabled = true;
                }
            }
        }


        // --- ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ ---
        // (ê¸°ì¡´ê³¼ ë™ì¼, ë³€ê²½ ì—†ìŒ)
        async function submitAnswer() {
            // ...
        }
        async function generateAIFeedbackForStudent(question, studentAnswer) {
            // ...
        }
        async function handleQuestionFormSubmit(e) {
            // ...
        }
        window.gradeSubmission = (questionId, studentId) => {
            // ...
        }
        window.downloadSubmissionsAsCSV = (questionId) => {
            // ...
        }
        window.deleteQuestion = async (id) => {
            // ...
        }
        function openQuestionModalForCreate() {
            // ...
        }
        window.openQuestionModalForEdit = (id) => {
            // ...
        }
        function closeQuestionModal() { 
            // ...
        }
        function addRubricItem(criterion = '', score = '') {
            // ...
        }

        // --- ì•± ì‹œì‘ ---
        initialize();
    </script>
</body>
</html>

